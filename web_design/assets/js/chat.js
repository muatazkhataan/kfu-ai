/**
 * ุงูููู ุงูุฑุฆูุณู ูููุญุงุฏุซุฉ - ูุณุงุนุฏ ููู
 * ูููู ุจุชุญููู ูุฑุจุท ุฌููุน ุงูุฃูุธูุฉ ุงููุฑุนูุฉ
 */

// ุงูุชุธุงุฑ ุชุญููู ุงูุตูุญุฉ
document.addEventListener("DOMContentLoaded", function () {
    console.log('๐ ุจุฏุก ุชุญููู ูุธุงู ูุณุงุนุฏ ููู...');

    // ุงูุชุญูู ูู ูุฌูุฏ ุฌููุน ุงููููุงุช ุงููุทููุจุฉ
    if (!window.IconSystem) {
        console.error('โ ูุธุงู ุงูุฃููููุงุช ุบูุฑ ูุชููุฑ!');
        return;
    }

    if (!window.kfuIconManager) {
        console.error('โ ูุธุงู ุฃููููุฉ ูุณุงุนุฏ ููู ุบูุฑ ูุชููุฑ!');
        return;
    }

    if (!window.folderManager) {
        console.error('โ ูุธุงู ุฅุฏุงุฑุฉ ุงููุฌูุฏุงุช ุบูุฑ ูุชููุฑ!');
        return;
    }

    if (!window.chatManager) {
        console.error('โ ูุธุงู ุฅุฏุงุฑุฉ ุงููุญุงุฏุซุงุช ุบูุฑ ูุชููุฑ!');
        return;
    }

    if (!window.utils) {
        console.error('โ ูุธุงู ุงููุธุงุฆู ุงููุณุงุนุฏุฉ ุบูุฑ ูุชููุฑ!');
        return;
    }

    // ุชููุฆุฉ ุงููุธุงู ุงูุฑุฆูุณู
    initializeMainSystem();

    // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุชุฑุญูุจ
    showWelcomeMessage();

    console.log('โ ุชู ุชุญููู ุฌููุน ุงูุฃูุธูุฉ ุจูุฌุงุญ!');
    console.log('๐จ ุฃููููุฉ ูุณุงุนุฏ ููู ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู!');
});

/**
 * ุชููุฆุฉ ุงููุธุงู ุงูุฑุฆูุณู
 */
function initializeMainSystem() {
    // ุฑุจุท ุงูุฃุญุฏุงุซ ุงูุนุงูุฉ
    bindGlobalEvents();

    // ุชููุฆุฉ ุงููุงูุฐุฉ ุงูููุจุซูุฉ
    initializeModal();

    // ุงูุชุฑููุฒ ุนูู ุญูู ุงูุฅุฏุฎุงู
    const chatInput = document.getElementById("chatInput");
    if (chatInput) {
        chatInput.focus();
    }

    console.log('โ ุชู ุชููุฆุฉ ุงููุธุงู ุงูุฑุฆูุณู ุจูุฌุงุญ!');
}

/**
 * ุฑุจุท ุงูุฃุญุฏุงุซ ุงูุนุงูุฉ
 */
function bindGlobalEvents() {
    // ุฅุบูุงู ุงููุงูุฐุฉ ุงูููุจุซูุฉ ุนูุฏ ุฅุบูุงููุง
    document.getElementById('addFolderModal').addEventListener('hidden.bs.modal', function () {
        window.pendingChatForNewFolder = null;
    });

    // ุฅุบูุงู ุงูููุงุฆู ุงูููุณุฏูุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
    document.addEventListener("click", function (e) {
        // ุฅุบูุงู ููุงุฆู ุงููุญุงุฏุซุงุช ุงูููุณุฏูุฉ
        if (!e.target.closest('.chat-item-actions')) {
            document.querySelectorAll('.chat-dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        // ุฅุบูุงู ููุงุฆู ุงููุฌูุฏุงุช ุงูููุณุฏูุฉ
        if (!e.target.closest('.folder-actions')) {
            document.querySelectorAll('.folder-dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        // ุฅุบูุงู ูุงุฆูุฉ ุงููุณุชุฎุฏู ุงูููุณุฏูุฉ
        if (!e.target.closest('.user-profile-section')) {
            closeUserDropdown();
        }
    });
}

/**
 * ุชููุฆุฉ ุงููุงูุฐุฉ ุงูููุจุซูุฉ
 */
function initializeModal() {
    // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฃููููุงุช ูู ุงููุงูุฐุฉ ุงูููุจุซูุฉ
    const folderIconSelect = document.getElementById('folderIcon');
    if (folderIconSelect && window.IconSystem) {
        const favoriteIcons = window.IconSystem.getFavoriteIcons();

        // ูุณุญ ุงูุฎูุงุฑุงุช ุงูุญุงููุฉ
        folderIconSelect.innerHTML = '';

        // ุฅุถุงูุฉ ุงูุฃููููุงุช ุงูููุถูุฉ
        favoriteIcons.forEach(icon => {
            const option = document.createElement('option');
            option.value = icon.class;
            option.textContent = `${icon.emoji} ${icon.name}`;
            folderIconSelect.appendChild(option);
        });
    }
}

// ===== ุฏูุงู ุงููุงุฌูุฉ ุงูุนุงูุฉ =====

/**
 * ุจุฏุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ
 */
function startNewChat() {
    if (window.chatManager) {
        window.chatManager.startNewChat();
    }
}

/**
 * ุชุญููู ูุญุงุฏุซุฉ
 */
function loadChat(chatId, event) {
    if (window.chatManager) {
        window.chatManager.loadChat(chatId, event);
    }
}

/**
 * ุฅุฑุณุงู ุฑุณุงูุฉ
 */
function sendMessage() {
    if (window.chatManager) {
        window.chatManager.sendMessage();
    }
}

/**
 * ุทุฑุญ ุณุคุงู
 */
function askQuestion(question) {
    if (window.chatManager) {
        window.chatManager.askQuestion(question);
    }
}

/**
 * ุฅุฑุณุงู ุงูุชุฑุงุญ
 */
function sendSuggestion(suggestion) {
    if (window.chatManager) {
        window.chatManager.sendSuggestion(suggestion);
    }
}

// ุชู ููู ุฌููุน ุฏูุงู ุชุฃุซูุฑ ุงููุชุงุจุฉ ุฅูู chat-manager.js ูุชูุญูุฏ ุงููุธุงู

/**
 * ุฅุบูุงู ูุงุฆูุฉ ุงููุณุชุฎุฏู ุงูููุณุฏูุฉ (Footer)
 */
function closeUserDropdown() {
    // ุงุณุชุฎุฏุงู UserProfileManager ูุฅุบูุงู ุงูููุชุฑ
    if (window.userProfileManager) {
        const footer = document.getElementById('sidebarFooterNew');
        if (footer && footer.classList.contains('show')) {
            window.userProfileManager.toggleFooter();
        }
    }
}

/**
 * ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุชุฑุญูุจ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
 */
function showWelcomeMessage() {
    // ุงูุชุฃูุฏ ูู ุฃู ุงูุตูุญุฉ ูุญููุฉ ุจุงููุงูู
    if (document.readyState === 'complete' && window.chatManager) {
        setTimeout(() => {
            const welcomeMessage = "ูุฑุญุจุงู! ุฃูุง ูุณุงุนุฏ ูููุ ุงููุณุงุนุฏ ุงูุฐูู ูุทูุจุฉ ุฌุงูุนุฉ ุงูููู ููุตู. ููู ูููููู ูุณุงุนุฏุชู ุงููููุ";
            window.chatManager.addMessageWithTyping(welcomeMessage, false, 30);
        }, 1000); // ุชุฃุฎูุฑ ูุตูุฑ ูุถูุงู ุชุญููู ูู ุดูุก
    }
}

/**
 * ูุญุงูุงุฉ ุฅุฌุงุจุฉ ุงูุฐูุงุก ุงูุตูุงุนู ูุน ุชุฃุซูุฑ ุงููุชุงุจุฉ ูุฏุนู HTML
 */
function simulateAIResponse(userMessage) {
    // ุงุณุชุฎุฏุงู chat-manager ุจุฏูุงู ูู ุงูุฏูุงู ุงูููุฑุฑุฉ
    if (window.chatManager) {
        // ุฅุถุงูุฉ ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุฃููุงู
        window.chatManager.addMessage(userMessage, true);

        // ูุญุงูุงุฉ ููุช ุงูุชูููุฑ
        setTimeout(() => {
            // ุฅุฌุงุจุฉ ูุฎุชููุฉ ุญุณุจ ููุน ุงูุณุคุงู ูุน ุฏุนู HTML
            let response = "";

            if (userMessage.includes("ุจุฑูุฌุฉ") || userMessage.includes("ููุฏ")) {
                response = `ุฃููุงู ุจู! ูููููู ูุณุงุนุฏุชู ูู <strong>ุงูุจุฑูุฌุฉ</strong>. ุฃูุง ูุชุฎุตุต ูู ูุบุงุช ุงูุจุฑูุฌุฉ ุงููุฎุชููุฉ ูุซู:<br><br>
                โข <code>Python</code> - ููุฐูุงุก ุงูุงุตุทูุงุนู ูุชุญููู ุงูุจูุงูุงุช<br>
                โข <code>JavaScript</code> - ูุชุทููุฑ ุงูููุจ ูุงูุชุทุจููุงุช<br>
                โข <code>Java</code> - ููุชุทุจููุงุช ุงููุจูุฑุฉ<br>
                โข <code>C++</code> - ููุจุฑูุฌุฉ ุนุงููุฉ ุงูุฃุฏุงุก<br><br>
                ูุง ูู ุงููุดุฑูุน ุงูุฐู ุชุนูู ุนูููุ ุฃู ูู ูุฏูู ุณุคุงู ูุญุฏุฏ ูู ุงูุจุฑูุฌุฉุ`;
            } else if (userMessage.includes("ุฑูุงุถูุงุช") || userMessage.includes("ุญุณุงุจ")) {
                response = `ูุฑุญุจุงู! ุฃูุง ููุง ููุณุงุนุฏุชู ูู <strong>ุงูุฑูุงุถูุงุช</strong>. ูููููู ูุณุงุนุฏุชู ูู:<br><br>
                ๐ <em>ุงูุฌุจุฑ</em> - ุงููุนุงุฏูุงุช ูุงููุชุบูุฑุงุช<br>
                ๐ <em>ุงูููุฏุณุฉ</em> - ุงูุฃุดูุงู ูุงููุณุงุญุงุช<br>
                ๐ <em>ุงูุชูุงุถู ูุงูุชูุงูู</em> - ุงูููุงูุงุช ูุงููุดุชูุงุช<br>
                ๐ข <em>ุงูุฅุญุตุงุก</em> - ุงูุชุญููู ูุงูุงุญุชูุงูุงุช<br><br>
                ูุง ูู ุงูููุถูุน ุงูุฑูุงุถู ุงูุฐู ุชุฑูุฏ ุงููุณุงุนุฏุฉ ูููุ`;
            } else if (userMessage.includes("ุงูุชุญุงู") || userMessage.includes("ุฏุฑุงุณุฉ")) {
                response = `ุฃููู ุฃูู ุชุฑูุฏ ุงููุณุงุนุฏุฉ ูู <strong>ุงูุฏุฑุงุณุฉ ูุงูุงูุชุญุงูุงุช</strong>. ูููููู ูุณุงุนุฏุชู ูู:<br><br>
                ๐ ุฅูุดุงุก ุฎุทุฉ ุฏุฑุงุณูุฉ ููุธูุฉ<br>
                ๐ก ุดุฑุญ ุงูููุงููู ุงูุตุนุจุฉ<br>
                ๐ฏ ูุตุงุฆุญ ููุชุญุถูุฑ ููุงูุชุญุงูุงุช<br>
                โฐ ุฅุฏุงุฑุฉ ุงูููุช ุจูุนุงููุฉ<br><br>
                ูุง ูู ุงูููุฑุฑ ุงูุฐู ุชุฑูุฏ ุงูุชุฑููุฒ ุนูููุ`;
            } else {
                response = `ุดูุฑุงู ูุณุคุงูู! ุฃูุง ููุง ููุณุงุนุฏุชู ูู ุฌููุน <strong>ุงููุฌุงูุงุช ุงูุฃูุงุฏูููุฉ</strong>. ูููููู ูุณุงุนุฏุชู ูู:<br><br>
                ๐ป ุงูุจุฑูุฌุฉ ูุงูุชุทููุฑ<br>
                ๐งฎ ุงูุฑูุงุถูุงุช ูุงูุนููู<br>
                ๐ ุงูุฏุฑุงุณุฉ ูุงูุงูุชุญุงูุงุช<br>
                ๐ ุงูุดุคูู ุงูุฃูุงุฏูููุฉ<br><br>
                ูู ููููู ุชูุถูุญ ุณุคุงูู ุฃูุซุฑ ุญุชู ุฃุชููู ูู ุชูุฏูู ุฃูุถู ูุณุงุนุฏุฉ ููููุฉุ`;
            }

            // ุฅุถุงูุฉ ุงูุฅุฌุงุจุฉ ูุน ุชุฃุซูุฑ ุงููุชุงุจุฉ ูุฏุนู HTML ุจุงุณุชุฎุฏุงู chat-manager
            window.chatManager.addMessageWithTyping(response, false, 20);
        }, 1000);
    }
}

// ุชู ููู ุฏุงูุฉ addUserMessage ุฅูู chat-manager.js ูุชูุญูุฏ ุงููุธุงู

/**
 * ูุชุญ ูุฌูุฏ
 */
function openFolder(folderId, event) {
    if (window.folderManager) {
        window.folderManager.openFolder(folderId, event);
    }
}

/**
 * ุชุจุฏูู ุงูุดุฑูุท ุงูุฌุงูุจู
 */
function toggleSidebar() {
    if (window.utils) {
        window.utils.toggleSidebar();
    }
}

// ===== ุฏูุงู ุฅุฏุงุฑุฉ ุงููุฌูุฏุงุช =====

/**
 * ุชุจุฏูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ูููุฌูุฏ
 */
function toggleFolderDropdown(event, folderId) {
    if (window.folderManager) {
        window.folderManager.toggleFolderDropdown(event, folderId);
    }
}

/**
 * ุฅุนุงุฏุฉ ุชุณููุฉ ุงููุฌูุฏ
 */
function renameFolder(folderId) {
    if (window.folderManager) {
        window.folderManager.renameFolder(folderId);
    }
}

/**
 * ุชุบููุฑ ุฃููููุฉ ุงููุฌูุฏ
 */
function changeFolderIcon(folderId, newIconClass) {
    if (window.folderManager) {
        window.folderManager.changeFolderIcon(folderId, newIconClass);
    }
}

/**
 * ุญุฐู ุงููุฌูุฏ
 */
function deleteFolder(folderId) {
    if (window.folderManager) {
        window.folderManager.deleteFolder(folderId);
    }
}

/**
 * ุฅุถุงูุฉ ูุฌูุฏ ุฌุฏูุฏ
 */
function addNewFolder() {
    if (window.folderManager) {
        window.folderManager.addNewFolder();
    }
}

/**
 * ุฅูุดุงุก ูุฌูุฏ ุฌุฏูุฏ
 */
function createNewFolder() {
    if (window.folderManager) {
        window.folderManager.createNewFolder();
    }
}

/**
 * ุชุจุฏูู ุงููุงุฆูุฉ ุงููุฑุนูุฉ ููุฃููููุงุช
 */
function toggleIconSubmenu(event, folderId) {
    if (window.folderManager) {
        window.folderManager.toggleIconSubmenu(event, folderId);
    }
}

// ===== ุฏูุงู ุฅุฏุงุฑุฉ ุงููุญุงุฏุซุงุช =====

/**
 * ุชุจุฏูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ูููุญุงุฏุซุฉ
 */
function toggleChatDropdown(event, chatId) {
    if (window.chatManager) {
        window.chatManager.toggleChatDropdown(event, chatId);
    }
}

/**
 * ูุดุงุฑูุฉ ุนูุตุฑ ุงููุญุงุฏุซุฉ
 */
function shareChatItem(chatId) {
    if (window.chatManager) {
        window.chatManager.shareChatItem(chatId);
    }
}

/**
 * ุฅุนุงุฏุฉ ุชุณููุฉ ุงููุญุงุฏุซุฉ
 */
function renameChat(chatId) {
    if (window.chatManager) {
        window.chatManager.renameChat(chatId);
    }
}

/**
 * ุฅุถุงูุฉ ุฅูู ูุฌูุฏ
 */
function addToFolder(chatId, folderType) {
    if (window.chatManager) {
        window.chatManager.addToFolder(chatId, folderType);
    }
}

/**
 * ุฃุฑุดูุฉ ุงููุญุงุฏุซุฉ
 */
function archiveChat(chatId) {
    if (window.chatManager) {
        window.chatManager.archiveChat(chatId);
    }
}

/**
 * ุญุฐู ุงููุญุงุฏุซุฉ
 */
function deleteChat(event, chatId) {
    if (window.chatManager) {
        window.chatManager.deleteChat(event, chatId);
    }
}

// ===== ุฏูุงู ุฅุฌุฑุงุกุงุช ุงููุญุงุฏุซุฉ =====

/**
 * ูุณุญ ุงููุญุงุฏุซุฉ
 */
function clearChat() {
    if (window.chatManager) {
        window.chatManager.clearChat();
    }
}

/**
 * ุชุตุฏูุฑ ุงููุญุงุฏุซุฉ
 */
function exportChat() {
    if (window.chatManager) {
        window.chatManager.exportChat();
    }
}

/**
 * ูุดุงุฑูุฉ ุงููุญุงุฏุซุฉ
 */
function shareChat() {
    if (window.chatManager) {
        window.chatManager.shareChat();
    }
}

// ===== ุฏูุงู ุฅุฌุฑุงุกุงุช ุงูุฅุฏุฎุงู =====

/**
 * ุฅุฑูุงู ููู
 */
function attachFile() {
    if (window.chatManager) {
        window.chatManager.attachFile();
    }
}

/**
 * ุชุณุฌูู ุตูุชู
 */
function recordVoice() {
    if (window.chatManager) {
        window.chatManager.recordVoice();
    }
}

// ===== ุฏูุงู ุฅุฌุฑุงุกุงุช ุงูุฑุณุงุฆู =====

/**
 * ูุณุฎ ุฑุณุงูุฉ
 */
function copyMessage(button) {
    if (window.chatManager) {
        window.chatManager.copyMessage(button);
    }
}

/**
 * ุฅุนุฌุงุจ ุจุฑุณุงูุฉ
 */
function likeMessage(button) {
    if (window.chatManager) {
        window.chatManager.likeMessage(button);
    }
}

// ===== ุฏูุงู ุงููุงุฌูุฉ =====

/**
 * ุฅุธูุงุฑ ุงูุฅุนุฏุงุฏุงุช
 */
function showSettings() {
    if (window.utils) {
        window.utils.showSettings();
    }
}

/**
 * ุฅุธูุงุฑ ุงููุณุงุนุฏุฉ
 */
function showHelp() {
    if (window.utils) {
        window.utils.showHelp();
    }
}

/**
 * ุฅุธูุงุฑ ุงูููุงุญุธุงุช
 */
function showFeedback() {
    if (window.utils) {
        window.utils.showFeedback();
    }
}

// ===== ุฏูุงู ุงูุงุฎุชุจุงุฑ =====

/**
 * ุงุฎุชุจุงุฑ ุงููุธุงู
 */
window.testSystem = function () {
    console.log('๐งช ุจุฏุก ุงุฎุชุจุงุฑ ุงููุธุงู...');

    // ุงุฎุชุจุงุฑ ูุธุงู ุงูุฃููููุงุช
    if (window.IconSystem) {
        console.log('โ ูุธุงู ุงูุฃููููุงุช:', window.IconSystem.getAllIcons().length, 'ุฃููููุฉ');
    }

    // ุงุฎุชุจุงุฑ ูุธุงู ุงููุฌูุฏุงุช
    if (window.folderManager) {
        console.log('โ ูุธุงู ุงููุฌูุฏุงุช:', window.folderManager.folders.size, 'ูุฌูุฏ');
    }

    // ุงุฎุชุจุงุฑ ูุธุงู ุงููุญุงุฏุซุงุช
    if (window.chatManager) {
        console.log('โ ูุธุงู ุงููุญุงุฏุซุงุช:', window.chatManager.chats.size, 'ูุญุงุฏุซุฉ');
    }

    // ุงุฎุชุจุงุฑ ูุธุงู ุงููุธุงุฆู ุงููุณุงุนุฏุฉ
    if (window.utils) {
        window.utils.test();
    }

    console.log('๐ ุงูุชูู ุงุฎุชุจุงุฑ ุงููุธุงู ุจูุฌุงุญ!');
};

/**
 * ุงุฎุชุจุงุฑ ุชุบููุฑ ุงูุฃููููุฉ
 */
window.testIconChange = function (folderId = 'all') {
    console.log('๐งช ุงุฎุชุจุงุฑ ุชุบููุฑ ุงูุฃููููุฉ ูููุฌูุฏ:', folderId);

    if (window.folderManager) {
        const randomIcon = window.IconSystem ? window.IconSystem.getRandomIcon() : null;
        if (randomIcon) {
            window.folderManager.changeFolderIcon(folderId, randomIcon.class);
        } else {
            window.folderManager.changeFolderIcon(folderId, 'fas fa-heart');
        }
    } else {
        alert('ูุธุงู ุฅุฏุงุฑุฉ ุงููุฌูุฏุงุช ุบูุฑ ูุชููุฑ!');
    }
};

// ===== ูุนูููุงุช ุงููุธุงู =====

console.log('๐ ูุนูููุงุช ุงููุธุงู:');
console.log('๐ ุงููููุงุช ุงููุทููุจุฉ:');
console.log('  - icons.js (ูุธุงู ุงูุฃููููุงุช)');
console.log('  - folders.js (ุฅุฏุงุฑุฉ ุงููุฌูุฏุงุช)');
console.log('  - chat-manager.js (ุฅุฏุงุฑุฉ ุงููุญุงุฏุซุงุช)');
console.log('  - utils.js (ุงููุธุงุฆู ุงููุณุงุนุฏุฉ)');
console.log('  - chat.js (ุงูููู ุงูุฑุฆูุณู)');

console.log('๐ง ุฏูุงู ุงูุงุฎุชุจุงุฑ ุงููุชุงุญุฉ:');
console.log('  - testSystem() - ุงุฎุชุจุงุฑ ุงููุธุงู ุจุงููุงูู');
console.log('  - testIconChange(folderId) - ุงุฎุชุจุงุฑ ุชุบููุฑ ุงูุฃููููุฉ');
console.log('  - utils.test() - ุงุฎุชุจุงุฑ ุงููุธุงุฆู ุงููุณุงุนุฏุฉ');

console.log('๐ฏ ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!');

// ===== ุฏูุงู ุงูููู ุงูุดุฎุตู ูููุณุชุฎุฏู =====
// ุชู ููู ูุฐู ุงูุฏูุงู ุฅูู user-profile.js ูุชุญุณูู ุงูุชูุธูู ูุงูุฃุฏุงุก